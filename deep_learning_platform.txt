# 基于 Ultralytics YOLO 的图像分割 / 检测深度学习平台  
（需求分析文档）

---

## 1. 项目背景与目标

### 1.1 背景

在图像分割 / 检测任务中，研究人员和工程师通常需要手动完成以下工作：

- 配置运行环境（CUDA、驱动版本、Python 依赖包等）
- 编写和调试 YOLO 训练脚本
- 管理数据集路径与格式，手动检查数据质量
- 在命令行中监控训练过程、排查错误
- 手动调整代码并反复运行

这些步骤繁琐、易出错，且不利于多人协作与重复利用。

### 1.2 项目目标

本项目拟开发一个 **基于 Ultralytics YOLO（仅支持 YOLOv8、YOLOv10）** 的图像分割 / 检测平台，实现：

1. 通过 **Gradio 可视化界面** 完成任务配置、下发、状态查询和训练过程可视化；
2. 在任务下发前自动检测 **CPU、GPU 数量、CUDA 版本、本地 pip 包等环境信息**，辅助判断是否具备训练条件（默认使用 `conda base` 环境）；
3. 在页面中选择 **数据集路径、YOLO 模型类型与预训练权重路径**，并自动检查数据集合法性（包括路径、图片尺寸、训练 / 验证 / 测试集数量等）；
4. 调用 **DeepSeek API 自动生成/修复训练 Python 脚本**，在本地环境中运行，并实时监控是否异常；发生异常时截取最近 100 行日志重新请求 DeepSeek 修改代码并重试；
5. 实现训练过程的 **日志、指标曲线、预测效果等可视化展示**。

---

## 2. 总体架构设计（概念层）

### 2.1 分层结构

平台整体可分为以下几层：

1. **界面层（Gradio 前端）**
   - 任务配置 UI
   - 任务列表/详情页
   - 实时日志与训练曲线可视化

2. **业务逻辑层（Python 后端）**
   - 环境检测模块
   - 数据集校验模块
   - 模型与参数配置管理模块
   - 任务编排与状态管理模块
   - 日志收集与异常处理模块
   - DeepSeek API 调用模块

3. **执行层**
   - 本地 Python 运行环境（`conda base`）
   - Ultralytics YOLO（v8/v10）
   - 由 DeepSeek 自动生成的训练脚本

4. **存储层**
   - 任务元数据（JSON/SQLite）
   - 训练日志文件
   - 模型权重输出目录
   - 指标记录（CSV/JSON/TensorBoard 日志等）

---

## 3. 功能需求

### 3.1 Gradio 前端界面

#### 3.1.1 页面结构

1. **首页 / 任务列表页**
   - 显示任务列表（分页或按时间排序）：
     - 任务 ID
     - 创建时间
     - 模型类型（YOLOv8 / YOLOv10 + detection/segmentation）
     - 数据集名称或路径
     - 当前状态：`PENDING` / `RUNNING` / `SUCCEEDED` / `FAILED` / `CANCELLED` / `RETRYING`
     - 当前 epoch / 总 epoch（可选）
   - 支持筛选：
     - 按状态
     - 按模型类型
     - 按关键字（任务 ID / 数据集路径）

2. **新建任务页**
   - 资源与环境检测按钮（或自动检测结果展示）
   - 数据集选择与校验区域
   - 模型与预训练权重配置区域
   - 训练超参数设置区域
   - “校验数据集”按钮
   - “生成并启动任务”按钮

3. **任务详情页**
   - 基本信息：
     - 任务 ID、创建时间
     - 数据集信息（路径、类型、样本数等）
     - 模型配置（YOLOv8/YOLOv10，预训练权重，device 等）
   - 运行状态：
     - 状态（Running/Failed/...）
     - 当前 epoch / 总 epoch
     - 最近一次日志输出时间
   - 日志面板：
     - 实时显示最新 N 行日志
     - 支持手动刷新 / 自动刷新
   - 指标可视化：
     - loss、mAP、IoU 等曲线
   - 样例可视化：
     - 验证集随机图像 + 模型预测结果

4. **系统信息页（可选）**
   - CPU 核数 / 内存信息
   - GPU 型号、数量、显存
   - CUDA 版本、驱动版本
   - 主要 pip 包及版本（torch、ultralytics、numpy 等）

---

### 3.2 资源与环境检测模块

#### 3.2.1 检测内容

1. **CPU 信息**
   - 物理核心数
   - 逻辑线程数（可选）

2. **GPU 信息**
   - 可用 GPU 数量
   - 每块 GPU 名称、显存大小
   - 当前显存占用（可选）
   - 通过 `nvidia-smi` 或 `torch.cuda.*` 实现

3. **CUDA / 驱动版本**
   - `nvidia-smi` 输出解析
   - `torch.version.cuda` 校验

4. **Python & pip 包信息**
   - Python 版本
   - 关键库版本：
     - `torch`
     - `ultralytics`
     - 其他依赖（如 `numpy`、`opencv-python`、`pyyaml` 等）

#### 3.2.2 使用方式与界面展示

- 用户在“新建任务页”点击 “环境检测” 按钮后：
  - 在页面显示检测结果（列表或表格）
  - 用简单提示标识是否满足 Ultralytics YOLO 的基本要求：
    - 如 torch + CUDA 版本是否匹配
    - ultralytics 是否已安装且版本合适
- 若缺少必要依赖，给出 **安装建议命令**（例如 `pip install ultralytics==x.y.z`），不强制自动安装。

---

### 3.3 数据集管理与合法性校验

#### 3.3.1 数据集选择方式

- 用户在前端输入或选择：
  - 数据集根目录路径（例如 `/data/yolo/my_dataset`）
  - 任务类型：
    - 目标检测（detect）
    - 实例分割（segment）
  - 数据配置方式：
    - 使用 YOLO 官方 `data.yaml` 文件（推荐）
    - 或者手动指定 train/val/test 的图片目录与 label 目录（可选）

#### 3.3.2 校验内容

1. **路径合法性检查**
   - 检查根路径存在性；
   - 若使用 `data.yaml`：
     - 检查 `train`、`val`、`test` 字段是否存在且路径有效；
     - 检查 `nc`、`names` 字段是否存在且长度匹配。
   - 若手动指定路径：
     - 检查图片目录与标签文件目录是否存在。

2. **图片文件检查**
   - 支持的图像格式：`jpg` / `jpeg` / `png` 等；
   - 遍历或随机采样若干图片，检查：
     - 宽高是否合理（不为 0，不明显过小）
     - 是否能正常读取。

3. **样本数量与划分检查**
   - 统计训练集、验证集、测试集：
     - 图像数量
     - 标签文件数量
   - 若使用标签可解析类别信息，统计类别分布（可选）；
   - 对样本过少情况给出提示（例如总样本 < X）。

4. **任务类型校验**
   - 若为检测任务：
     - 检查 label 格式是否符合 YOLO 检测标签格式；
   - 若为分割任务：
     - 检查 seg 标签格式 / mask 文件存在等（根据 ultralytics 的 seg 格式）。

#### 3.3.3 界面反馈

- 校验通过：绿色提示 + 核心统计信息（样本数、类别数、图片尺寸范围等）；
- 校验失败：红色错误说明，指出具体问题（路径不存在、图片为空、label 缺失等）。

---

### 3.4 模型与训练参数配置模块

#### 3.4.1 模型选择

用户可在前端选择：

- 模型系列：
  - `YOLOv8`
  - `YOLOv10`
- 任务类型：
  - `detect`
  - `segment`
- 模型规模（视 ultralytics 支持）：
  - `n`, `s`, `m`, `l`, `x` 等

#### 3.4.2 预训练权重配置

- 输入本地 `.pt` 文件路径（例如 `/models/yolov8n.pt`）；
- 校验：
  - 文件是否存在；
  - （可选）尝试简要加载模型，验证能否实例化 YOLO 对象；
- 限制：
  - 需声明只支持 Ultralytics YOLO 权重。

#### 3.4.3 训练参数配置

常用训练参数（前端表单）：

- 基础参数：
  - `epochs`（训练轮数）
  - `batch_size`
  - `imgsz`（输入图像大小）
- 优化参数：
  - 初始学习率 `lr0`
  - `lrf`、`momentum` 等（可做为“高级选项”）
- 运行参数：
  - `device`：如 `0` / `1` / `0,1` / `cpu`
  - `workers`：Dataloader 线程数
- 日志与保存：
  - 是否保存最优模型
  - 是否开启额外日志（如 TensorBoard，若使用）

---

### 3.5 任务编排与 DeepSeek 代码生成

#### 3.5.1 统一任务配置对象

服务端根据前端填入的配置生成一个 **任务配置 JSON 对象**，包括：

- 数据集信息（路径、任务类型、data.yaml 路径等）
- 模型信息（系列、任务类型、预训练权重、device 等）
- 训练参数（epochs、batch_size、imgsz 等）
- 运行参数：
  - 项目根目录：`projects/<task_id>/`
  - 日志路径：`projects/<task_id>/train.log`
  - 权重输出目录：`projects/<task_id>/weights/`

#### 3.5.2 DeepSeek API 调用逻辑

1. 组装 Prompt：
   - 当前任务配置 JSON
   - 当前环境信息（torch/ultralytics 版本、CUDA 等）
   - 要求约束，例如：
     - 使用 `from ultralytics import YOLO`
     - 根据任务类型（detect/segment）进行相应训练调用
     - 使用指定的 data.yaml 和训练参数
     - 将日志输出到指定文件
2. 调用 DeepSeek，生成训练脚本源码：
   - 例如生成 `train_v1.py`
3. 将源码保存至：
   - `projects/<task_id>/train.py`（或带版本号）

#### 3.5.3 本地运行与进程管理

- 使用 `subprocess.Popen` 等方式运行脚本：
  - 命令示例：`python train.py`
  - 标准输出和标准错误重定向到统一日志文件 `train.log`
- 后端维护任务状态：
  - `PENDING`：创建但未启动
  - `RUNNING`：脚本运行中
  - `RETRYING`：异常后正在自动重试
  - `SUCCEEDED`：正常结束
  - `FAILED`：多次重试后仍失败或严重错误
  - `CANCELLED`：用户手动停止
- 若支持用户终止任务：
  - 通过 PID 杀死对应进程，并更新状态为 `CANCELLED`

---

### 3.6 异常处理与日志回流 DeepSeek

#### 3.6.1 异常判定规则

- 进程返回码非 0；
- 日志中包含明显错误关键字（如 `Traceback`, `RuntimeError`, `CUDA out of memory` 等）；
- 若引入心跳机制，长时间无日志输出也可判定异常（可选）。

#### 3.6.2 日志采集与裁剪

- 在判定异常后：
  - 打开对应 `train.log` 文件；
  - 从末尾向前读取最近 100 行（不足 100 行则全部读取）；
  - 将这些日志作为错误上下文，连同上一版训练脚本、任务配置一起作为 Prompt 发送给 DeepSeek。

#### 3.6.3 自动修复与重试策略

- 系统配置一个最大自动重试次数，例如：`max_retry = 3`；
- 每次异常：
  1. 收集最后 100 行日志；
  2. 请求 DeepSeek“修复脚本”，生成新版本 `train_v2.py` / `train_v3.py`；
  3. 更新任务状态为 `RETRYING`，再次以新脚本启动训练；
- 超过最大重试次数后：
  - 任务状态置为 `FAILED`；
  - 在任务详情页提示：
    - 错误日志摘要
    - 已生成的各版本脚本路径，方便人工排查。

---

### 3.7 训练过程可视化

#### 3.7.1 指标曲线展示

- 根据 Ultralytics 训练输出（`results.csv` 或 YAML/JSON 等）解析指标：
  - 训练 loss（box_loss、seg_loss 等）
  - 验证 mAP（mAP50、mAP50-95）
  - 其他关键指标
- 在 Gradio 中绘制折线图：
  - 横轴为 epoch 或 step
  - 纵轴为对应指标值
- 支持切换不同指标、仅看 train 或 val 等。

#### 3.7.2 验证集样例可视化

- 在训练完成或中途：
  - 从验证集随机抽取若干图片；
  - 使用当前训练得到的权重进行推理；
  - 将预测结果（框 / 掩码）叠加在原图上并展示；
- 前端提供“刷新样例”按钮，重新抽样或重新推理。

#### 3.7.3 资源利用情况（可选）

- 周期性调用 `nvidia-smi` / `pynvml` 等接口：
  - 获取 GPU 利用率、显存使用情况；
- 在任务详情页以简单折线图或数字展示。

---

## 4. 非功能需求

### 4.1 性能需求

- 同一台机器上允许同时运行的训练任务数可配置：
  - 默认为 1～2 个；
- 对任务列表和指标查询的响应时间要求：
  - 常规操作应在 1～2 秒内完成（在任务数量有限的前提下）。

### 4.2 可扩展性

- 模块化设计，后续可扩展：
  - 新的模型族（未来如果不再限制只能 YOLO）；
  - 新的任务类型（如关键点检测）；
  - 分布式训练（目前暂不考虑）。

### 4.3 可靠性

- 服务意外重启后：
  - 再次读取本地任务元数据与日志；
  - 对状态为 `RUNNING` 的任务进行合理恢复（例如标记为 `UNKNOWN` 或检查进程是否仍在）；
- 日志与模型文件均持久化至磁盘。

### 4.4 安全性

- 若未来支持多用户：
  - 每个用户数据集、项目目录进行权限隔离；
- DeepSeek 生成的代码需在 Prompt 中约束，不允许执行任意系统指令（避免安全风险）。

### 4.5 可维护性

- 核心模块示例：
  - `ResourceChecker`：环境检测
  - `DatasetValidator`：数据集校验
  - `TaskManager`：任务创建、状态管理
  - `DeepSeekClient`：与 DeepSeek API 交互
  - `RunExecutor`：脚本运行与进程管理
  - `LogManager`：日志存储与尾部读取
- 为各模块提供清晰接口说明与基础单元测试。

---

## 5. 数据结构与配置示例

### 5.1 任务配置示例（JSON）

```json
{
  "task_id": "20251211-0001",
  "dataset": {
    "root": "/data/yolo/my_dataset",
    "data_yaml": "/data/yolo/my_dataset/data.yaml",
    "type": "detection"
  },
  "model": {
    "family": "yolov8",
    "task": "detect",
    "pretrained_weights": "/models/yolov8n.pt",
    "device": "0"
  },
  "train_params": {
    "epochs": 100,
    "batch_size": 16,
    "imgsz": 640,
    "lr0": 0.01,
    "workers": 8
  },
  "runtime": {
    "project_dir": "/projects/20251211-0001",
    "log_path": "/projects/20251211-0001/train.log",
    "weights_output_dir": "/projects/20251211-0001/weights"
  }
}
